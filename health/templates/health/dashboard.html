{% extends "base/base.html" %}
{% block signup %}{% endblock %}

{% block sidebar %}
<aside
  class="hidden md:flex fixed left-6 top-1/2 -translate-y-1/2 backdrop-blur-xl bg-white/10 border border-white/20 shadow-[0_8px_32px_rgba(0,0,0,0.6)] rounded-2xl py-8 px-6 flex-col items-center h-[64vh] w-22 z-40 transition">
  <div class="flex flex-col gap-8 w-full">
    <!-- Home -->
    <a href="/" class="w-14 h-14 flex items-center justify-center rounded-xl bg-white/10 border border-white/20 text-indigo-400 hover:bg-indigo-600 hover:text-white hover:scale-110 transition" title="Home">
      <i class="fas fa-house text-lg"></i>
    </a>
    <!-- Habits -->
    <a href="{% url 'health:track_habits' %}" class="w-14 h-14 flex items-center justify-center rounded-xl bg-white/10 border border-white/20 text-green-400 hover:bg-green-600 hover:text-white hover:scale-110 transition" title="Track Habits">
      <i class="fas fa-clipboard-list text-lg"></i>
    </a>
    <!-- Stress -->
    <a href="{% url 'health:stress_log' %}" class="w-14 h-14 flex items-center justify-center rounded-xl bg-white/10 border border-white/20 text-yellow-400 hover:bg-yellow-600 hover:text-white hover:scale-110 transition" title="Stress Log">
      <i class="fas fa-brain text-lg"></i>
    </a>
    <!-- Reminders -->
    <a href="{% url 'health:reminders' %}" class="w-14 h-14 flex items-center justify-center rounded-xl bg-white/10 border border-white/20 text-pink-400 hover:bg-pink-600 hover:text-white hover:scale-110 transition" title="Reminders">
      <i class="fas fa-bell text-lg"></i>
    </a>
    <!-- Back -->
    <button onclick="history.back()" class="w-14 h-14 flex items-center justify-center rounded-xl bg-white/10 border border-white/20 text-red-400 hover:bg-red-600 hover:text-white hover:scale-110 transition" title="Go Back">
      <i class="fas fa-arrow-left text-lg"></i>
    </button>
  </div>
</aside>
{% endblock %}

{% block mobile_nav %}
<nav
  class="md:hidden fixed bottom-4 left-1/2 -translate-x-1/2 backdrop-blur-xl bg-white/10 border border-white/20 shadow-[0_8px_32px_rgba(0,0,0,0.4)] rounded-full px-8 py-3 flex justify-center gap-10 z-40">
  <a href="/" class="text-indigo-400 hover:text-white hover:scale-110 transition" title="Home"><i class="fas fa-house text-xl"></i></a>
  <a href="{% url 'health:track_habits' %}" class="text-green-400 hover:text-white hover:scale-110 transition" title="Track Habits"><i class="fas fa-clipboard-list text-xl"></i></a>
  <a href="{% url 'health:stress_log' %}" class="text-yellow-400 hover:text-white hover:scale-110 transition" title="Stress Log"><i class="fas fa-brain text-xl"></i></a>
  <a href="{% url 'health:reminders' %}" class="text-pink-400 hover:text-white hover:scale-110 transition" title="Reminders"><i class="fas fa-bell text-xl"></i></a>
  <button onclick="history.back()" class="text-red-400 hover:text-white hover:scale-110 transition" title="Go Back"><i class="fas fa-arrow-left text-xl"></i></button>
</nav>
{% endblock %}

{% block content %}
<div class="relative min-h-screen flex items-center justify-center bg-gradient-to-br from-gray-950 via-gray-900 to-gray-950 overflow-hidden">
  <!-- Three.js canvas -->
  <canvas id="bgCanvas" class="absolute inset-0 w-full h-full"></canvas>

  <!-- Glassmorphic Card -->
  <div class="relative z-10 w-full max-w-6xl rounded-2xl backdrop-blur-lg bg-white/5 border border-indigo-400/20 shadow-2xl p-6 md:p-10 animate-fadeIn">

    <!-- Welcome -->
    <div class="text-center mb-6">
      <p class="text-2xl md:text-3xl font-bold bg-gradient-to-r from-indigo-400 via-blue-300 to-purple-400 text-transparent bg-clip-text drop-shadow-lg inline-block">
        Welcome, <span class="text-pink-400 animate-pulse">{{ user.username }}</span>
        <i class="fas fa-heartbeat text-red-400 ml-2 animate-bounce"></i>
      </p>
    </div>

    <!-- Title -->
    <h2 class="text-4xl font-extrabold mb-8 text-transparent bg-clip-text bg-gradient-to-r from-green-400 via-teal-300 to-indigo-200 drop-shadow-[0_0_12px_rgba(16,185,129,0.6)] text-center tracking-wide">
      Health Dashboard
    </h2>

    <!-- Stats Overview -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-10 text-center">
      <div class="p-6 rounded-xl bg-gradient-to-br from-blue-500/20 to-blue-800/10 border border-blue-400/30">
        <h3 class="text-lg font-semibold text-blue-300">Sleep</h3>
        <p class="text-3xl font-bold text-slate-200">{{ sleep_hours }}h</p>
      </div>
      <div class="p-6 rounded-xl bg-gradient-to-br from-cyan-500/20 to-cyan-800/10 border border-cyan-400/30">
        <h3 class="text-lg font-semibold text-cyan-300">Hydration</h3>
        <p class="text-3xl font-bold text-slate-200">{{ water_intake }}L</p>
      </div>
      <div class="p-6 rounded-xl bg-gradient-to-br from-green-500/20 to-green-800/10 border border-green-400/30">
        <h3 class="text-lg font-semibold text-green-300">Meals</h3>
        <p class="text-3xl font-bold text-slate-200">{{ meals_count }}</p>
      </div>
      <div class="p-6 rounded-xl bg-gradient-to-br from-purple-500/20 to-purple-800/10 border border-purple-400/30">
        <h3 class="text-lg font-semibold text-purple-300">Exercise</h3>
        <p class="text-3xl font-bold text-slate-200">{{ exercise_minutes }}m</p>
      </div>
    </div>

    <!-- AI Health Suggestions -->
    <div class="mb-10 p-6 rounded-xl bg-gradient-to-br from-pink-500/10 to-purple-500/10 border border-pink-400/20">
      <h3 class="text-xl font-semibold text-pink-300 mb-4 text-center">Health Suggestions</h3>
      <ul class="space-y-2 text-gray-200 text-center">
        {% if sleep_hours < 6 %}
          <li><i class="fas fa-bed text-yellow-400 mr-2"></i>Try to sleep at least 7â€“8 hours tonight.</li>
        {% endif %}
        {% if water_intake < 2 %}
          <li><i class="fas fa-tint text-blue-400 mr-2"></i>Drink more water for better focus and hydration.</li>
        {% endif %}
        {% if exercise_minutes < 20 %}
          <li><i class="fas fa-running text-green-400 mr-2"></i>Try to move or exercise for at least 30 minutes today.</li>
        {% endif %}
        {% for log in stress_logs|slice:":1" %}
          {% if log.stress_level >= 7 %}
            <li><i class="fas fa-spa text-pink-400 mr-2"></i>You seem stressed. Consider meditation or deep breathing.</li>
          {% endif %}
        {% endfor %}
        {% if sleep_hours >= 7 and water_intake >= 2 and exercise_minutes >= 30 %}
          <li><i class="fas fa-star text-yellow-400 mr-2"></i>Excellent! Your health habits are on track today.</li>
        {% endif %}
      </ul>
    </div>
    <!-- Stress Logs -->
    <div class="overflow-x-auto rounded-xl shadow-lg mb-10">
      <table class="w-full border-collapse rounded-lg overflow-hidden">
        <thead>
          <tr class="bg-green-500/20 text-green-300">
            <th class="p-4 text-left">Date</th>
            <th class="p-4 text-center">Mood</th>
            <th class="p-4 text-center">Stress Level</th>
            <th class="p-4 text-center">Notes</th>
          </tr>
        </thead>
        <tbody>
          {% for log in stress_logs %}
          <tr class="border-b border-gray-700 text-gray-200 hover:bg-green-500/10 transition duration-200 ease-in-out">
            <td class="p-4 font-medium">{{ log.date|date:"M d, H:i" }}</td>
            <td class="p-4 text-center">{{ log.get_mood_display }}</td>
            <td class="p-4 text-center">{{ log.stress_level }}/10</td>
            <td class="p-4 text-center">{{ log.notes|default:"-" }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="4" class="p-4 text-center text-gray-400">No logs yet.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Habits Chart -->
    <div class="rounded-xl p-6 bg-white/5 border border-green-400/20 shadow-lg">
      <h3 class="text-xl font-semibold text-green-300 mb-4 text-center">Habits Trend</h3>
      <div class="w-full overflow-x-auto">
        <div class="min-w-[600px] md:min-w-0">
          <canvas id="healthChart" class="w-full h-96"></canvas>
        </div>
      </div>
      <p class="text-xs text-gray-400 mt-2 text-center md:hidden">
        Scroll left/right to view the graph
      </p>
    </div>

  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const ctx = document.getElementById('healthChart').getContext('2d');
new Chart(ctx, {
  type: 'line',
  data: {
    labels: [{% for d in dates %}"{{ d }}",{% endfor %}],
    datasets: [
      { label: 'Sleep (h)', data: [{% for s in sleep_data %}{{ s }},{% endfor %}], borderColor: 'rgba(59,130,246,1)', backgroundColor: 'rgba(59,130,246,0.3)', tension: 0.4, borderWidth: 2, fill: true },
      { label: 'Water (L)', data: [{% for w in water_data %}{{ w }},{% endfor %}], borderColor: 'rgba(16,185,129,1)', backgroundColor: 'rgba(16,185,129,0.3)', tension: 0.4, borderWidth: 2, fill: true },
      { label: 'Exercise (m)', data: [{% for e in exercise_data %}{{ e }},{% endfor %}], borderColor: 'rgba(139,92,246,1)', backgroundColor: 'rgba(139,92,246,0.3)', tension: 0.4, borderWidth: 2, fill: true }
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { legend: { labels: { color: '#e5e7eb' } } },
    scales: {
      x: { ticks: { color: '#e5e7eb' }, grid: { color: 'rgba(99,102,241,0.1)' } },
      y: { ticks: { color: '#e5e7eb' }, grid: { color: 'rgba(99,102,241,0.1)' } }
    }
  }
});
</script>

<!-- Three.js Particle Background -->
<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
<script>
const canvas = document.getElementById("bgCanvas");
const renderer = new THREE.WebGLRenderer({ canvas, alpha: true });
renderer.setSize(window.innerWidth, window.innerHeight);

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
camera.position.z = 8;

const particlesCount = 2500;
const geometry = new THREE.BufferGeometry();
const positions = [];
for (let i = 0; i < particlesCount; i++) {
  positions.push((Math.random() - 0.5) * 50);
  positions.push((Math.random() - 0.5) * 50);
  positions.push((Math.random() - 0.5) * 50);
}
geometry.setAttribute("position", new THREE.Float32BufferAttribute(positions, 3));

const material = new THREE.PointsMaterial({ color: 0x22d3ee, size: 0.06, transparent: true, opacity: 0.8 });
const particles = new THREE.Points(geometry, material);
scene.add(particles);

function animate() {
  requestAnimationFrame(animate);
  particles.rotation.y += 0.0008;
  particles.rotation.x += 0.0003;
  renderer.render(scene, camera);
}
animate();

window.addEventListener("resize", () => {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>
{% endblock %}
