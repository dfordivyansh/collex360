{% extends "base/base.html" %} 
{% block signup %}{% endblock %} 



{% block sidebar %}
<aside
  class="hidden md:flex fixed left-6 top-1/2 -translate-y-1/2 backdrop-blur-xl bg-white/10 border border-white/20 shadow-[0_8px_32px_rgba(0,0,0,0.6)] rounded-2xl py-8 px-6 flex-col items-center h-[50vh] w-22 z-40 transition">
  <div class="flex flex-col gap-8 w-full">
    <!-- Home -->
    <a
      href="/"
      class="w-14 h-14 flex items-center justify-center rounded-xl bg-white/10 border border-white/20 text-indigo-400 hover:bg-indigo-600 hover:text-white hover:scale-110 transition"
      title="Home">
      <i class="fas fa-house text-lg"></i>
    </a>

    <!-- Add Subject -->
    <a
      href="/attendance/add/"
      class="w-14 h-14 flex items-center justify-center rounded-xl bg-white/10 border border-white/20 text-green-400 hover:bg-green-600 hover:text-white hover:scale-110 transition"
      title="Add Subject">
      <i class="fas fa-plus text-lg"></i>
    </a>

    <!-- Mark Attendance -->
    <a
      href="/attendance/mark/"
      class="w-14 h-14 flex items-center justify-center rounded-xl bg-white/10 border border-white/20 text-yellow-400 hover:bg-yellow-600 hover:text-white hover:scale-110 transition"
      title="Mark Attendance">
      <i class="fas fa-calendar-check text-lg"></i>
    </a>

    <!-- Back -->
    <button
      onclick="history.back()"
      class="w-14 h-14 flex items-center justify-center rounded-xl bg-white/10 border border-white/20 text-red-400 hover:bg-red-600 hover:text-white hover:scale-110 transition"
      title="Go Back">
      <i class="fas fa-arrow-left text-lg"></i>
    </button>
  </div>
</aside>
{% endblock %} 

{% block mobile_nav %}
<nav
  class="md:hidden fixed bottom-4 left-1/2 -translate-x-1/2 backdrop-blur-xl bg-white/10 border border-white/20 shadow-[0_8px_32px_rgba(0,0,0,0.4)] rounded-full px-8 py-3 flex justify-center gap-10 z-40">
  <!-- Home -->
  <a
    href="/"
    class="text-indigo-400 hover:text-white hover:scale-110 transition"
    title="Home">
    <i class="fas fa-house text-xl"></i>
  </a>

  <!-- Add Subject -->
  <a
    href="/attendance/add/"
    class="text-green-400 hover:text-white hover:scale-110 transition"
    title="Add Subject">
    <i class="fas fa-plus text-xl"></i>
  </a>

  <!-- Mark Attendance -->
  <a
    href="/attendance/mark/"
    class="text-yellow-400 hover:text-white hover:scale-110 transition"
    title="Mark Attendance">
    <i class="fas fa-calendar-check text-xl"></i>
  </a>

  <!-- Back -->
  <button
    onclick="history.back()"
    class="text-red-400 hover:text-white hover:scale-110 transition"
    title="Go Back">
    <i class="fas fa-arrow-left text-xl"></i>
  </button>
</nav>
{% endblock %} 
{% block content %}

<div
  class="relative min-h-screen flex items-center justify-center bg-gradient-to-br from-gray-950 via-gray-900 to-gray-950 overflow-hidden">
  <!-- Three.js canvas -->
  <canvas id="bgCanvas" class="absolute inset-0 w-full h-full"></canvas>

  <!-- Glassmorphic Card -->
  <div
    class="relative z-10 w-full max-w-6xl rounded-2xl backdrop-blur-lg bg-white/5 border border-indigo-400/20 shadow-2xl p-6 md:p-10 animate-fadeIn">

<!-- Logged-in Username -->
<div class="text-center mb-6">
  <p
    class="text-2xl md:text-3xl font-bold 
           bg-gradient-to-r from-indigo-400 via-blue-300 to-purple-400 
           text-transparent bg-clip-text 
           animate-fadeIn drop-shadow-lg inline-block"
  >
    Welcome, 
    <span class="text-pink-400 animate-pulse">{{ user.username }}</span>
    <i class="fas fa-hand-peace text-yellow-400 ml-2 animate-bounce"></i>
  </p>
</div>

    <!-- Title -->
    <h2
      class="text-4xl font-extrabold mb-8 text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 via-blue-300 to-slate-200 drop-shadow-[0_0_12px_rgba(99,102,241,0.6)] text-center tracking-wide">
      Attendance Dashboard
    </h2>

    <!-- Stats Overview -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10 text-center">
      <div
        class="p-6 rounded-xl bg-gradient-to-br from-indigo-500/20 to-indigo-800/10 border border-indigo-400/30">
        <h3 class="text-lg font-semibold text-indigo-300">Overall %</h3>
        <p
          class="text-3xl font-bold {% if overall_pct < 75 %}text-rose-400{% else %}text-green-400{% endif %}">
          {{ overall_pct }}%
        </p>
      </div>
      <div
        class="p-6 rounded-xl bg-gradient-to-br from-blue-500/20 to-blue-800/10 border border-blue-400/30">
        <h3 class="text-lg font-semibold text-blue-300">Total Classes</h3>
        <p class="text-3xl font-bold text-slate-200">{{ total_classes }}</p>
      </div>
      <div
        class="p-6 rounded-xl bg-gradient-to-br from-rose-500/20 to-rose-800/10 border border-rose-400/30">
        <h3 class="text-lg font-semibold text-rose-300">Required Days</h3>
        <p class="text-3xl font-bold text-yellow-300">{{ required_days }}</p>
      </div>
    </div>

    <!-- Table -->
    <div class="overflow-x-auto rounded-xl shadow-lg mb-10">
      <table class="w-full border-collapse rounded-lg overflow-hidden">
        <thead>
          <tr class="bg-indigo-500/20 text-indigo-300">
            <th class="p-4 text-left">Subject</th>
            <th class="p-4 text-center">Present</th>
            <th class="p-4 text-center">Total</th>
            <th class="p-4 text-center">%</th>
            <th class="p-4 text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for subj in subjects %}
          <tr
            class="border-b border-gray-700 text-gray-200 hover:bg-indigo-500/10 transition duration-200 ease-in-out">
            <td class="p-4 font-medium">{{ subj.name }}</td>
            <td class="p-4 text-center">{{ subj.attendance_present }}</td>
            <td class="p-4 text-center">{{ subj.attendance_total }}</td>
            <td
              class="p-4 text-center font-semibold {% if subj.percentage < 75 %}text-rose-400 drop-shadow-[0_0_6px_rgba(244,63,94,0.6)]{% else %}text-green-400 drop-shadow-[0_0_6px_rgba(34,197,94,0.6)]{% endif %}">
              {{ subj.percentage }}%
            </td>
            <td class="p-4 text-center">
              <form method="post" class="inline-flex space-x-2">
                {% csrf_token %}
                <input type="hidden" name="subject_id" value="{{ subj.id }}" />
                <button
                  name="action"
                  value="present"
                  class="px-3 py-1 rounded-lg bg-green-600/80 hover:bg-green-500 text-white transition shadow-md hover:scale-105">
                  Present
                </button>
                <button
                  name="action"
                  value="add"
                  class="px-3 py-1 rounded-lg bg-blue-600/80 hover:bg-blue-500 text-white transition shadow-md hover:scale-105">
                  +1
                </button>
                <button
                  name="action"
                  value="remove"
                  class="px-3 py-1 rounded-lg bg-red-600/80 hover:bg-red-500 text-white transition shadow-md hover:scale-105">
                  -1
                </button>
                <!-- Delete Subject -->
                <button
                  name="action"
                  value="delete"
                  onclick="return confirm('Are you sure you want to delete this subject?');"
                  class="px-3 py-1 rounded-lg bg-rose-700/80 hover:bg-rose-600 text-white transition shadow-md hover:scale-105">
                  Delete
                </button>
              </form>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="5" class="p-4 text-center text-gray-400">
              No subjects added yet.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
<!-- Toggle AI Insights Button -->
<div class="text-center mb-8">
  <button id="toggleInsightsBtn"
    class="px-8 py-3 rounded-full bg-gradient-to-r from-blue-700 via-cyan-600 to-teal-600
           text-white font-bold text-lg tracking-wide shadow-lg transform hover:scale-105 
           transition-all duration-500 border border-cyan-400/40 backdrop-blur-md">
    <i class="fas fa-robot mr-2"></i> Show AI Insights
  </button>
</div>

<!-- AI Insights -->
<div id="aiInsightsSection"
  class="hidden mb-10 p-6 rounded-2xl relative overflow-hidden bg-gradient-to-br from-slate-900/50 via-slate-800/40 to-slate-900/30
         border border-cyan-500/20 shadow-xl backdrop-blur-md scale-95 opacity-0 transition-all duration-1000">
  
  <!-- Subtle background glow -->
  <div class="absolute inset-0 pointer-events-none opacity-20">
    <div class="w-full h-full bg-[radial-gradient(circle_at_30%_40%,rgba(0,200,255,0.25),transparent_60%),radial-gradient(circle_at_70%_70%,rgba(0,255,200,0.25),transparent_60%)]"></div>
  </div>

  <!-- Heading -->
  <h3 class="text-3xl font-extrabold text-center mb-8 relative z-10 holo-text-pro tracking-wide">
    <i class="fas fa-robot mr-2"></i> AI Attendance Insights
  </h3>

  <!-- Cards -->
  <div class="grid md:grid-cols-2 gap-6 text-gray-100 relative z-10">
    {% for subj in subjects %}
    <div
      class="ai-card p-5 rounded-xl bg-gradient-to-br from-slate-800/40 via-slate-900/30 to-slate-800/40
             border border-cyan-400/30 shadow-md backdrop-blur-md 
             transition-all duration-700 hover:scale-105 hover:shadow-cyan-400/40">
      <h4 class="text-xl font-bold text-cyan-300 mb-3 tracking-wide">
        {{ subj.name }}
      </h4>

      <p class="text-sm mb-1">
        <i class="fas fa-check-circle text-emerald-400 mr-1"></i>
        Current: <span class="font-semibold text-emerald-300">{{ subj.percentage }}%</span>
      </p>

      <p class="text-sm mb-1">
        <i class="fas fa-chart-line text-blue-400 mr-1"></i>
        Forecast: <span class="font-semibold text-blue-300">{{ subj.forecast }}%</span> by semester end
      </p>

      <p class="text-sm mb-1">
        <i class="fas fa-exclamation-triangle text-amber-300 mr-1"></i>
        Required Days: <span class="font-semibold text-amber-300">{{ subj.required }}</span> more classes
      </p>

      {% if subj.risk %}
      <p class="text-sm text-red-400 mt-1"><i class="fas fa-skull-crossbones mr-1"></i> High Risk: Attendance may drop below safe level</p>
      {% else %}
      <p class="text-sm text-emerald-400 mt-1"><i class="fas fa-shield-alt mr-1"></i> Safe: Likely above threshold</p>
      {% endif %}

      {% if subj.prob_safe %}
      <p class="text-sm mt-1"><i class="fas fa-brain text-cyan-400 mr-1"></i> ML Prediction: <span class="font-semibold text-cyan-300">{{ subj.prob_safe }}%</span> chance safe</p>
      {% endif %}

      {% if subj.forecast_trend %}
      <p class="text-sm mt-1"><i class="fas fa-chart-area text-indigo-400 mr-1"></i> Next 7-day trend: <span class="font-semibold text-indigo-300">{{ subj.forecast_trend }}%</span></p>
      {% endif %}
    </div>
    {% endfor %}
  </div>
</div>

<!-- Animations -->
<style>
/* Section Reveal */
.show-section {
  display: block !important;
  opacity: 1 !important;
  transform: scale(1) translateY(0) !important;
}

/* Card Reveal */
.ai-card {
  opacity: 0;
  transform: translateY(20px) scale(0.95);
}
.ai-card.show {
  opacity: 1;
  transform: translateY(0) scale(1);
  transition: all 0.8s ease-out;
}

/* Professional Holographic Text */
.holo-text-pro {
  background: linear-gradient(90deg, #38bdf8, #14b8a6, #3b82f6);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-size: 200% auto;
  animation: shimmerPro 4s linear infinite;
}
@keyframes shimmerPro {
  to { background-position: 200% center; }
}
</style>

<!-- Toggle Script -->
<script>
document.getElementById("toggleInsightsBtn").addEventListener("click", function () {
  const section = document.getElementById("aiInsightsSection");
  const cards = section.querySelectorAll(".ai-card");

  if (section.classList.contains("show-section")) {
    section.classList.remove("show-section");
    cards.forEach(c => c.classList.remove("show"));
    this.innerHTML = '<i class="fas fa-robot mr-2"></i> Show AI Insights';
  } else {
    section.classList.add("show-section");
    cards.forEach((c, i) => {
      setTimeout(() => c.classList.add("show"), i * 150);
    });
    this.innerHTML = '<i class="fas fa-robot mr-2"></i> Hide AI Insights';
  }
});
</script>



    <!-- Graph Section -->
    <div
      class="rounded-xl p-6 bg-white/5 border border-indigo-400/20 shadow-lg">
      <h3 class="text-xl font-semibold text-indigo-300 mb-4 text-center">Attendance Breakdown</h3>


      <!-- Scrollable container for mobile -->
      <div class="w-full overflow-x-auto">
        <div class="min-w-[600px] md:min-w-0">
          <canvas id="attendanceChart" class="w-full h-166 md:h-96"></canvas>
        </div>
      </div>

      <p class="text-xs text-gray-400 mt-2 text-center md:hidden">
        Scroll left/right to view the graph
      </p>
    </div>
  </div>
</div>

<!-- Three.js Animated Background -->
<script>
  const canvas = document.getElementById("bgCanvas");
  const renderer = new THREE.WebGLRenderer({ canvas, alpha: true });
  renderer.setSize(window.innerWidth, window.innerHeight);

  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(
    75,
    window.innerWidth / window.innerHeight,
    0.1,
    1000
  );
  camera.position.z = 8;

  const particlesCount = 2500;
  const geometry = new THREE.BufferGeometry();
  const positions = [];
  for (let i = 0; i < particlesCount; i++) {
    positions.push((Math.random() - 0.5) * 50);
    positions.push((Math.random() - 0.5) * 50);
    positions.push((Math.random() - 0.5) * 50);
  }
  geometry.setAttribute(
    "position",
    new THREE.Float32BufferAttribute(positions, 3)
  );

  const material = new THREE.PointsMaterial({
    color: 0x6366f1,
    size: 0.06,
    transparent: true,
    opacity: 0.8,
  });

  const particles = new THREE.Points(geometry, material);
  scene.add(particles);

  function animate() {
    requestAnimationFrame(animate);
    particles.rotation.y += 0.0008;
    particles.rotation.x += 0.0003;
    renderer.render(scene, camera);
  }
  animate();

  window.addEventListener("resize", () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });

</script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const ctx = document.getElementById('attendanceChart').getContext('2d');
  const attendanceChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: [{% for subj in subjects %}"{{ subj.name }}",{% endfor %}],
      datasets: [{
        label: 'Attendance %',
        data: [{% for subj in subjects %}{{ subj.percentage }},{% endfor %}],
        backgroundColor: 'rgba(99, 102, 241, 0.6)',
        borderColor: 'rgba(99, 102, 241, 1)',
        borderWidth: 1,
        borderRadius: 8
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          max: 100,
          ticks: {
            color: '#e5e7eb'
          },
          grid: {
            color: 'rgba(99, 102, 241, 0.1)'
          }
        },
        x: {
          ticks: {
            color: '#e5e7eb'
          },
          grid: {
            color: 'rgba(99, 102, 241, 0.1)'
          }
        }
      },
      plugins: {
        legend: {
          labels: {
            color: '#e5e7eb'
          }
        }
      }
    }
  });
</script>
{% endblock %}
